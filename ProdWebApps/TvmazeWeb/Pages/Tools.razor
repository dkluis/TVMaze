@page "/tools"
@using MySqlConnector

@code
{
    string message;
    int refreshshowid;
    string logview = "";
    readonly string log = "";

    public void ExecUpdateFollowed()
    {
        message = "Running Update Followed";
        RunScript("/Users/dick/TVMaze/Scripts/UpdateFollowed.sh");
        message = "Finished Update Followed";
    }

    public void ExecUpdatePlexAcquired()
    {
        message = "Running Update Plex Acquired";
        RunScript("/Users/dick/TVMaze/Scripts/UpdatePlexAcquired.sh");
        message = "Finished Update Plex Acquired";
    }

    public void ExecUpdatePlexWatched()
    {
        message = "Running Update Plex Watched";
        RunScript("/Users/dick/TVMaze/Scripts/UpdatePlexWatched.sh");
        message = "Finished Update Plex Watched";
    }

    public void ExecAcquireMedia()
    {
        message = "Running Acquire Media";
        RunScript("/Users/dick/TVMaze/Scripts/AcquireMedia.sh");
        message = "Finished Acquire Media";
    }

    public void ExecAcquireMediaLog()
    {
        logview = "Acquire Media Log";
    }

    public void ExecFollowedLog()
    {
        logview = "Followed Log";
    }

    public void ExecPlexAcquiredLog()
    {
        logview = "Plex Acquired Log";
    }

    public void ExecPlexWatchedLog()
    {
        logview = "Plex Watched Log";
    }


    private void RunScript(string script)
    {
        using (Process Script = new())
        {
            Script.StartInfo.FileName = script;
            Script.StartInfo.UseShellExecute = true;
            Script.StartInfo.RedirectStandardOutput = false;
            var started = Script.Start();
            Script.WaitForExit();
        }
    }

    private void RefreshOneShow()
    {
        if (refreshshowid == 0)
        {
            message = "Enter a ShowId: 0 is not Valid";
            return;
        }
        message = $"Trying to update {refreshshowid}";

        AppInfo appinfo = new("TVMaze", "RefreshOneShow WebUI", "DbAlternate");
        var log = appinfo.TxtFile;
        log.Start();
        using (MariaDB Mdbr = new(appinfo))
        {
            MySqlDataReader rdr;

            rdr = Mdbr.ExecQuery($"select `TvmShowId`, `ShowName` from Shows where `TvmShowId` = {refreshshowid} order by `TvmShowId` desc");

            while (rdr.Read())
            {
                using (ShowAndEpisodes sae = new(appinfo))
                {
                    message = $"Working on Show {rdr[0]} {rdr[1]}";
                    log.Write($"{message}", "", 2);
                    sae.Refresh(int.Parse(rdr[0].ToString()));
                }
            }
            if (message.Contains("Trying"))
            {
                message = $"ShowId {refreshshowid} is not in the Shows Table";
            }
            else
            {
                message = message.Replace("Working on", "Refreshed");
            }
        }
        log.Stop();
    }

}

<h1>Tools Page</h1>
<div>
    <h2>Batch Update Processes: </h2>
    <p></p>
    <button class="btn btn-primary" @onclick="ExecUpdateFollowed">Followed</button>
    &#8195;<button class="btn btn-primary" @onclick="ExecUpdatePlexAcquired">Plex Acquired</button>
    &#8195;<button class="btn btn-primary" @onclick="ExecUpdatePlexWatched">Plex Watched</button>
    &#8195;<button class="btn btn-primary" @onclick="ExecAcquireMedia">Acquire</button>
    <p></p>
</div>

<div>
    <h2>Direct Update Processes:</h2>
    <p></p>
    <input @bind="@refreshshowid" size="5"/>
    &#8195;<button class="btn btn-primary" @onclick="RefreshOneShow">Refresh Show</button>
    <p></p>
</div>

<div>
    <h2>Status:</h2>
    <div>
        <h4>
            <em>@message</em>
        </h4>
    </div>
</div>

<div>
    <h2>Logs</h2>
    <p></p>
    <button class="btn btn-primary" @onclick="ExecFollowedLog">Followed</button>
    &#8195;<button class="btn btn-primary" @onclick="ExecPlexAcquiredLog">Plex Acquired</button>
    &#8195;<button class="btn btn-primary" @onclick="ExecPlexWatchedLog">Plex Watched</button>
    &#8195;<button class="btn btn-primary" @onclick="ExecAcquireMediaLog">Acquire</button>
    <p></p>
</div>

<div>
    <h4>@logview</h4>
    <p></p>
    @log
    <p></p>
    <em>End of Log @logview</em>
</div>